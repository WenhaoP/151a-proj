```{r}
library(dplyr)
library(ggplot2)
```

```{r}
birth <- read.csv("data/US_births(2018).csv")
```

```{r}
head(birth)
nrow(birth)
```

```{r}
# Reduce the dimensionality of the dataset

# drop columns where >99% entries are the same
clean_birth <- birth %>% select(!c(DOB_YY, IMP_SEX, IP_GON, MAGE_IMPFLG, 
                                   MAR_IMP, MM_AICU, MTRAN))
```


```{r}
# Remove missing values

# remove missing values in the response variable
clean_birth <- subset(birth, DBWT != 9999)

# remove missing values in the features to be considered for adding interactions
clean_birth <- subset(clean_birth, PRECARE != 99 & CIG_0 != 99 & BMI != 99.9 
               & PREVIS != 99 & MRAVE6 != 9 & PAY_REC != 9
               & FRACE6 != 9 & MEDUC != 9 & FEDUC != 9 
               & NO_RISKS != 9)

# remove missing values in the features not to be considered for adding interactions
clean_birth <- subset(clean_birth, ATTEND != 9 & BFACIL != 9 & FAGECOMB != 99 
               & RF_CESAR != "U" & LD_INDL != "U" & MBSTATE_REC != 3
               & M_Ht_In != 99 & NO_INFEC != 9 & NO_MMORB != 9 
               & PRIORLIVE != 99 & PRIORTERM != 99 & RDMETH_REC != 9)

# remove missing values in the features for feature engineering
clean_birth <- subset(clean_birth, DLMP_YY != 9999 & DLMP_MM != 99)
clean_birth <- subset(clean_birth, PWgt_R != 999  & WTGAIN != 99)
clean_birth <- subset(clean_birth, ILLB_R != 999)
```

```{r}
nrow(clean_birth)
```

```{r}
# Feature engineering

# estimate pregnancy length
clean_birth$PREG_LEN <- 12*(2018 - clean_birth$DLMP_YY) + (clean_birth$DOB_MM - clean_birth$DLMP_MM)

# categorize and cap pregnancy length
clean_birth$PREG_LEN[clean_birth$PREG_LEN < 8] <- -1
clean_birth$PREG_LEN[clean_birth$PREG_LEN > 10] <- 99
clean_birth$PREG_LEN <- factor(clean_birth$PREG_LEN)
levels(clean_birth$PREG_LEN) <- c("Early", "8", "9", "10", "Late")

# compute percentage weight gain
clean_birth$WTGAIN_PER <- clean_birth$WTGAIN / clean_birth$PWgt_R

# binarize CIG_0
clean_birth$CIG_0 <- ifelse(clean_birth$CIG_0 > 0, TRUE, FALSE)

# compute first tiem live birth
clean_birth$FIRST_BIRTH <- ifelse(clean_birth$ILLB_R == 888, TRUE, FALSE)
```

```{r}
count <- clean_birth %>%
  group_by(ILLB_R) %>%
  summarise(n = n())

count
```

```{r}
set.seed(151)
EDA_size = 3000
EDA_df <- clean_birth %>% slice_sample(n = EDA_size, replace = TRUE)
```

```{r}
write.csv(EDA_df, "data/EDA.csv")
```


